<!DOCTYPE html>
<html>
<head>
	<title>Lay-Z-Spa Module | SPA Config</title>
	<meta charset="utf-8">
	<link rel="icon" type="image/png" sizes="180x180" href="favicon.png">
	<meta name="theme-color" content="#0f4677">
	<!-- <link rel="manifest" href="manifest.json"> -->
	<link rel="stylesheet" href="main.css">
	<meta  name="viewport" content="width=device-width, initial-scale=1 maximum-scale=1">
	<!-- <script src="function.js" type="text/javascript"></script> -->
</head>

<body>
	<div id="site">
		<header>
            <form id="darkModeForm">
                <label class="switch">
                    <input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()">
                    <span class="slider round"></span>
                </label>
            </form>
			<a href="./"><div id="header"><span>SPA Config</span><span>Lay-Z-Spa Module</span></div></a>
			<a href="javascript:void(0);" class="topnavicon" onclick="topNav()"></a>
		</header>

		<div class="topnav" id="topnav">
			<a href="./">Home</a>
			<a href="hwconfig.html">Hardware Config</a>
			<a href="config.html" class="active">SPA Config</a>
			<a href="webconfig.html">Web Config</a>
			<a href="wifi.html">Network Config</a>
			<a href="mqtt.html">MQTT Config</a>
			<a href="/dir/">Directory</a>
			<a href="upload.html">File Uploader</a>
			<a href="remove.html">File Remover</a>
			<a href="chkupdatefw.html">Check firmware update</a>
			<a href="/restart/">Restart ESP</a>
			<!-- <a href="javascript:void(0);" class="bgred" onclick="sendCommand('restartEsp')">Restart ESP</a> -->
		</div>

        <section>
                <table>
                    <!--tr>
                        <td><label for="timezone">Not used:</label></td>
                        <td><input type="text" id="timezone" value="0" maxlength="2" size="2"></td>
                    </tr-->
                    <tr>
                        <td><label for="price">Price per kWh:</label></td>
                        <td><input type="text" id="price" value="1.50" maxlength="4" size="4"></td>
                    </tr>
                    <tr>
                        <td><label for="clinterval">Chlorine add (Days):</label></td>
                        <td><input type="text" id="clinterval" value="7" maxlength="3" size="3"></td>
                    </tr>
                    <tr>
                        <td><label for="finterval">Filter change (Days):</label></td>
                        <td><input type="text" id="freplaceinterval" value="60" maxlength="3" size="3"></td>
                    </tr>
                    <tr>
                        <td><label for="finterval">Filter clean (Days):</label></td>
                        <td><input type="text" id="fcleaninterval" value="20" maxlength="3" size="3"></td>
                    </tr>
                    <tr>
                        <td><label for="finterval">Filter rinse (Days):</label></td>
                        <td><input type="text" id="frinseinterval" value="7" maxlength="3" size="3"></td>
                    </tr>
                    <tr>
                        <td><label for="audio">Audio:</label></td>
                        <td><input type="checkbox" id="audio"></td>
                    </tr>
                    <tr>
                        <td><label for="notification">Notification:</label></td>
                        <td><input type="checkbox" id="notification"></td>
                    </tr>
                    <tr>
                        <td><label for="notificationtime">Notification time (s):</label></td>
                        <td><input type="text" id="notificationtime" value="32" maxlength="3" size="3"></td>
                    </tr>
                    <tr>
                        <td><label for="restore">Restore last states on startup:</label></td>
                        <td><input type="checkbox" id="restore"></td>
                    </tr>
                    <tr>
                        <td><label for="calibration">Calibrated:</label><span data-text="If checked, the virtual temperature is calibrated. Redo calibration by unchecking and hitting SAVE button." class="tooltip">?</span></td>
                        <td><input type="checkbox" id="calibration" onclick="toggleCalibration()"><span data-text="Calibrate by keeping heat OFF and pump ON until temperature has dropped a couple of degrees. Do not toggle jets, bubbles etc meanwhile. Water temp must differ several degrees from ambient from start." class="tooltip left">?</span></td>
                        <td><a href="calib.html">manual cal.</a></td>
                    </tr>
                </table>
        </section>
        <section>
            <table>Enabled display buttons.<label for="toggle_all"> All:</label><input type="checkbox" id="toggle_all" onclick="toggleAll()">
                <tr>
                    <td><label for="lock_btn">Lock</label><input type="checkbox" id="lock_btn"></td>
                    <td><label for="timer_btn">Timer</label><input type="checkbox" id="timer_btn"></td>
                    <td><label for="bubbles_btn">Air</label><input type="checkbox" id="bubbles_btn"></td>
                    <td><label for="unit_btn">Unit</label><input type="checkbox" id="unit_btn"></td>
                    <td><label for="heat_btn">Heat</label><input type="checkbox" id="heat_btn"></td>
                </tr>
                <tr>
                    <td><label for="pump_btn">Pump</label><input type="checkbox" id="pump_btn"></td>
                    <td><label for="down_btn">Down</label><input type="checkbox" id="down_btn"></td>
                    <td><label for="up_btn">Up</label><input type="checkbox" id="up_btn"></td>
                    <td><label for="power_btn">Pwr</label><input type="checkbox" id="power_btn"></td>
                    <td><label for="hydrojets_btn">Jets</label><input type="checkbox" id="hydrojets_btn"></td>
                </tr>
            </table>
            <table><tr>
                <td colspan="2" class="center"><button id="save" class="button" onclick="buttonConfirm(this);saveConfig()">save</button></td>
            </tr></table>
        </section>

        <section>
            <table>
                <tr>Allowed values in "()"
                    <td><label for="commands">Command:</label></td>
                    <td>
                        <select name="commands" id="commands">
                            <option value="0">Set target temp (20-40/68-104)</option>
                            <option value="1">Set unit (0/1)</option>
                            <option value="2">Set air bubbles (0/1)</option>
                            <option value="3">Set heater (0/1)</option>
                            <option value="4">Set filter pump (0/1)</option>
                            <option value="5">Reset queue (-)</option>
                            <option value="6">Reboot ESP</option>
                            <option value="7">Internal command (get target) (-)</option>
                            <option value="8">Reset times (-)</option>
                            <option value="9">Reset Cl timer (-)</option>
                            <option value="10">Reset filter change timer (-)</option>
                            <option value="11">Set hydrojets (0/1)</option>
                            <option value="12">Set display brightness (0-8)</option>
                            <option value="13">Set beep (0/1 or 2+text=filename)</option>
                            <option value="14">Set ambient temp F (any integer)</option>
                            <option value="15">Set ambient temp C (any integer)</option>
                            <option value="16">Reset daily meter (any integer)</option>
                            <option value="17">Take control (0/1)</option>
                            <option value="18">Set full power (0/1)</option>
                            <option value="19">Print (text)</option>
                            <option value="20">Set ready time (-)</option>
                            <option value="21">Set R (internal use)</option>
                            <option value="22">Reset filter rinse timer (-)</option>
                            <option value="23">Reset filter clean timer (-)</option>
                            <option value="24">Set power on/off (0/1)</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td><label for="val">Value:</label></td>
                    <td><input type="text" id="val" value="1" maxlength="3" size="3"></td>
                </tr>
                <tr>
                    <td><label for="xtime">Execute time:</label><br /></td>
                    <td><input type="datetime-local" id="xtime" name="xtime" onchange="totimestamp()" step="1"></td>
                </tr>
                <tr>
                    <td><label for="interval">Repeat interval</label></td>
                    <td><input type="text" id="interval" value="0" maxlength="8" size="8"> seconds</td>
                </tr>
                <tr>
                    <td colspan="2"><p>(0=once, 1h=3600, 1d=86400, 1w=604800)</p></td>
                </tr>
                <tr>
                    <td><label for="txt">Text</label></td>
                    <td><input type="text" id="txt" value="" maxlength="24" size="16"> Text</td>
                </tr>
            </table>
        </section>
        
        <section style="text-align: left">
            <h2>Command queue</h2>
            <table id="cmdq"></table>
            <table>
                <tr>
                    <td colspan="2" class="center"><button id="addcmd" class="button" onclick="buttonConfirm(this);addCommand()">Add new</button></td>
                    <td colspan="2" class="center"><button id="resetq" class="button_red" onclick="buttonConfirm(this);resetCommandQueue()">Clear queue</button></td>
                </tr>
                <tr>
                    <td colspan="2" class="center"><button id="saveq" class="button" onclick="savetofile()">Save to file</button></td>
                    <td colspan="2" class="center"><button id="loadq" class="button" onclick="buttonConfirm(this);loadfromfile()">Load from file</button></td>
                </tr>
            </table>
        </section>

        <footer>
            <p class="center" id="lastboot">Last boot: loading...</p>
        </footer>
</div>

<script>
  function topNav() {
    var x = document.getElementById("topnav");
    if (x.className === "topnav") {
      x.className += " responsive";
    } else {
      x.className = "topnav";
    }
  }

  function togglePlainText(id) {
    var x = document.getElementById(id);
    if (x.type === "password") {
      x.type = "text";
    } else {
      x.type = "password";
    }
  }

  function validatePassword(id) {
    var x = document.getElementById(id);
    if (x.value == "<enter password>") {
      alert("Please enter a password to continue.");
      return false;
    }
    return true;
  }

  // Function to update the displayed number
  function updateNumber(opt, parent) {
    var parentElement = parent.parentElement;
    var numDisplay = parentElement.querySelector(".numDisplay");
    var number = parseInt(numDisplay.textContent);
    if (opt == "up") number += 1;
    if (opt == "dn") number -= 1;
    numDisplay.textContent = number;
  }

  function increaseNumber(id) {
    var x = document.getElementById(id);
    var val = Number(x.value);
    var max = x.max;
    if (max > val) {
      val += 1;
      x.value = val;
    }
    var opt = "up";
    updateNumber(opt, x);
  }

  function decreaseNumber(id) {
    var x = document.getElementById(id);
    var val = Number(x.value);
    var min = x.min;
    if (min < val) {
      val -= 1;
      x.value = val;
    }
    var opt = "dn";
    updateNumber(opt, x);
  }

  function buttonConfirm(elem, text = "", timeout = 3, reset = true) {
    var originalText = elem.innerHTML;

    elem.innerHTML = text == "" ? "&check;" : text;
    elem.disabled = true;

    if (reset) {
      setTimeout(function () {
        elem.innerHTML = originalText;
        elem.disabled = false;
      }, timeout * 1000);
    }
  }

</script>

<script>
loadConfig();

const settarget = 0;
const setunit = 1;
const setbubbles = 2;
const setheat = 3;
const setpump = 4;
const resetq = 5;
const rebootesp = 6;
const gettarget = 7;
const resettimes = 8;
const resetcl = 9;
const resetreplacefilter = 10;
const setjets = 11;
const setbrightness = 12;
const setbeep = 13;
const setambientf = 14;
const setambientc = 15;
const resetdaily = 16;
const godmode = 17;
const fullpower = 18;
const printtext = 19;
const setready = 20;
const setR = 21;
const resetrinsefiltertimer = 22;
const resetcleanfiltertimer = 23;
const setpower = 24;

const commandlist = [
	'Set target', 'Set unit', 'Set bubbles', 'Set heat', 'Set pump', 'Reset queue', 'Reboot ESP',
	'Internal cmd', 'Reset times', 'Reset Cl timer', 'Reset change filter timer', 'Set jets', 'Set brightness',
	'Beep', 'Set ambient temp F.', 'Set ambient temp C.', 'Reset daily meter', 'Take control', 'Full power',
    'Print text', 'Set ready', 'Set R', 'Reset rinse filter timer', 'Reset clean filter timer', 'Set power'
];

function totimestamp()
{
	console.log(Date.parse(document.getElementById("xtime").value)/1000);
	console.log("value "+document.getElementById("xtime").value);
}

function loadConfig()
{
	var req = new XMLHttpRequest();
	req.open('POST', '/getconfig/');
	req.send();
	req.onreadystatechange = function()
	{
		if (this.readyState == 4 && this.status == 200)
		{
			var json = JSON.parse(req.responseText);
			console.log(json);
			//document.getElementById('timezone').value = json.TIMEZONE.toString();
			document.getElementById('price').value = json.PRICE.toString();
			document.getElementById('freplaceinterval').value = json.FREPI.toString();
			document.getElementById('frinseinterval').value = json.FRINI.toString();
			document.getElementById('fcleaninterval').value = json.FCLEI.toString();
			document.getElementById('clinterval').value = json.CLINT.toString();
			document.getElementById('audio').checked = json.AUDIO;
			document.getElementById('notification').checked = json.NOTIFY;
			document.getElementById('notificationtime').value = json.NOTIFTIME.toString();
			document.getElementById('restore').checked = json.RESTORE;
			var date = new Date(json.REBOOTTIME * 1000);
			document.getElementById('lastboot').innerHTML = 'Last boot: ' + date.toLocaleString() + ' ' + json.REBOOTINFO;
            document.getElementById('calibration').checked = json.VTCAL;
            document.getElementById('lock_btn').checked = json.LCK;
            document.getElementById('timer_btn').checked = json.TMR;
            document.getElementById('bubbles_btn').checked = json.AIR;
            document.getElementById('unit_btn').checked = json.UNT;
            document.getElementById('heat_btn').checked = json.HTR;
            document.getElementById('pump_btn').checked = json.FLT;
            document.getElementById('down_btn').checked = json.DN;
            document.getElementById('up_btn').checked = json.UP;
            document.getElementById('power_btn').checked = json.PWR;
            document.getElementById('hydrojets_btn').checked = json.HJT;
		}
	}

	setInterval(loadCommandQueue, 4000);

	var now = new Date();
	var offset = now.getTimezoneOffset() * 60000;
	var adjustedDate = new Date(now.getTime() - offset);
	var formattedDate = adjustedDate.toISOString().substring(0,16); // For minute precision
	var datetimeField = document.getElementById('xtime');
	datetimeField.value = formattedDate;
}

function saveConfig()
{
	var req = new XMLHttpRequest();
	req.open('POST', '/setconfig/');
	var json = {
		//'TIMEZONE':parseInt(document.getElementById('timezone').value),
		'TIMEZONE':0,
		'PRICE':parseFloat(document.getElementById('price').value),
		'FREPI':parseInt(document.getElementById('freplaceinterval').value),
		'FRINI':parseInt(document.getElementById('frinseinterval').value),
		'FCLEI':parseInt(document.getElementById('fcleaninterval').value),
		'CLINT':parseInt(document.getElementById('clinterval').value),
		'AUDIO':document.getElementById('audio').checked,
		'NOTIFY':document.getElementById('notification').checked,
		'NOTIFTIME':parseInt(document.getElementById('notificationtime').value),
		'RESTORE':document.getElementById('restore').checked,
        'VTCAL':document.getElementById('calibration').checked,
        'LCK':document.getElementById('lock_btn').checked,
        'TMR':document.getElementById('timer_btn').checked,
        'AIR':document.getElementById('bubbles_btn').checked,
        'UNT':document.getElementById('unit_btn').checked,
        'HTR':document.getElementById('heat_btn').checked,
        'FLT':document.getElementById('pump_btn').checked,
        'DN':document.getElementById('down_btn').checked,
        'UP':document.getElementById('up_btn').checked,
        'PWR':document.getElementById('power_btn').checked,
        'HJT':document.getElementById('hydrojets_btn').checked
	};
	req.send(JSON.stringify(json));
	console.log(json);
}

function toggleAll()
{
    document.getElementById('lock_btn').checked = document.getElementById('toggle_all').checked;
    document.getElementById('timer_btn').checked = document.getElementById('toggle_all').checked;
    document.getElementById('bubbles_btn').checked = document.getElementById('toggle_all').checked;
    document.getElementById('unit_btn').checked = document.getElementById('toggle_all').checked;
    document.getElementById('heat_btn').checked = document.getElementById('toggle_all').checked;
    document.getElementById('pump_btn').checked = document.getElementById('toggle_all').checked;
    document.getElementById('down_btn').checked = document.getElementById('toggle_all').checked;
    document.getElementById('up_btn').checked = document.getElementById('toggle_all').checked;
    document.getElementById('power_btn').checked = document.getElementById('toggle_all').checked;
    document.getElementById('hydrojets_btn').checked = document.getElementById('toggle_all').checked;
}

function loadCommandQueue()
{
	var req = new XMLHttpRequest();
	req.open('POST', '/getcommands/');
	req.send();
	req.onreadystatechange = function()
	{
		if (this.readyState == 4 && this.status == 200)
		{
			var json = JSON.parse(req.responseText);
			console.log(json);
			var table = document.getElementById('cmdq');
            table.innerHTML = '';
            
			for (var i = 0; i < json.LEN; i++)
			{
                var row = table.insertRow();
                var cell = row.insertCell(0);
                cell.innerHTML = '<button id="editCmd' + i + '" class="button" onclick="editCommandQueue('+i+')">Set</button>';
                var date = new Date(json.XTIME[i] * 1000);
                cell = row.insertCell(1);
                cell.innerHTML = commandlist[json['CMD'][i]] + ':' + json['VALUE'][i] + '<br>' + date.toLocaleString() + '<br>Interval: ' + json['INTERVAL'][i] + 's';
                cell = row.insertCell(2);
                cell.innerHTML = '<button id="delCmd' + i + '" class="button_red" onclick="delCommand('+i+')">Del</button>';
			}
		}
	}
}

function addCommand()
{
	var req = new XMLHttpRequest();
	req.open('POST', '/addcommand/');
	var json = {
		'CMD':parseInt(document.getElementById('commands').value),
		'VALUE':parseFloat(document.getElementById('val').value),
		'XTIME':Date.parse(document.getElementById('xtime').value)/1000,
		'INTERVAL':parseInt(document.getElementById('interval').value),
        'TXT':document.getElementById('txt').value
	};
	req.send(JSON.stringify(json));
	console.log(json);
}

function resetCommandQueue()
{
	var req = new XMLHttpRequest();
	req.open('POST', '/addcommand/');
	var json = {
		'CMD':resetq,
		'VAL':1,
		'XTIME':0,
		'INTERVAL':0
	};
	req.send(JSON.stringify(json));
	console.log(json);
	loadCommandQueue();
}

function savetofile()
{
    var filename=prompt("Please enter a filename","mycommandqueue1");
    if(filename == null) return;
	var req = new XMLHttpRequest();
	req.open('POST', '/cmdq_file/');
	var json = {
		'ACT':'save',
		'NAME':filename
	};
	req.send(JSON.stringify(json));
	console.log(json);
}

function loadfromfile()
{
    var filename=prompt("Please enter a filename","mycommandqueue1");
    if(filename == null) return;
	var req = new XMLHttpRequest();
	req.open('POST', '/cmdq_file/');
	var json = {
		'ACT':'load',
		'NAME':filename
	};
	req.send(JSON.stringify(json));
	console.log(json);
}

function editCommandQueue(index)
{
	var req = new XMLHttpRequest();
	req.open('POST', '/editcommand/');
	var json = {
		'CMD':parseInt(document.getElementById('commands').value),
		'VALUE':parseFloat(document.getElementById('val').value),
		'XTIME':Date.parse(document.getElementById('xtime').value)/1000,
		'INTERVAL':parseInt(document.getElementById('interval').value),
        'TXT':document.getElementById('txt').value,
        'IDX':index
	};
	req.send(JSON.stringify(json));
	console.log(json);
}

function delCommand(index)
{
	var req = new XMLHttpRequest();
	req.open('POST', '/delcommand/');
	var json = {
        'IDX':index
	};
	req.send(JSON.stringify(json));
	console.log(json);
}

function toggleCalibration()
{
    let obj = document.getElementById('calibration');
    if(obj.checked) obj.checked = false;
}
</script>
<script src="darkmode.js" type="text/javascript"></script>

</body>
</html>
